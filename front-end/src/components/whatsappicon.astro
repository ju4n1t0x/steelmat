---
import { Image } from "astro:assets";
import WhatsappIconImg from "@/assets/icons/whatsapp.webp";
---

<a
  href="https://api.whatsapp.com/send/?phone=5493425524299&text&type=phone_number&app_absent=0"
  target="_blank"
  rel="noopener noreferrer"
  class={`whatsapp-link-selector fixed transition-all duration-500 ease-in-out`}
  style="z-index: 99999; right: 1rem; opacity: 0;"
>
  <Image
    src={WhatsappIconImg}
    alt="WhatsApp"
    width={48}
    height={48}
    loading="lazy"
    class="w-12 h-12"
  />
</a>
<script>
  // Estado global para el WhatsApp icon
  declare global {
    interface Window {
      __whatsappIcon?: {
        isCustomPosition: boolean;
        isHidden: boolean;
        link: HTMLElement | null;
        updatePosition: () => void;
      };
    }
  }

  // Inicializar estado global inmediatamente
  window.__whatsappIcon = {
    isCustomPosition: false,
    isHidden: false,
    link: null,
    updatePosition: () => {},
  };

  // Registrar event listeners inmediatamente (antes de DOMContentLoaded)
  window.addEventListener("whatsapp:hide", () => {
    const state = window.__whatsappIcon;
    if (state) {
      state.isHidden = true;
      state.isCustomPosition = true;
      if (state.link) {
        state.link.style.opacity = "0";
        state.link.style.pointerEvents = "none";
      }
    }
  });

  window.addEventListener("whatsapp:show", () => {
    const state = window.__whatsappIcon;
    if (state) {
      state.isHidden = false;
      if (state.link) {
        state.link.style.opacity = "1";
        state.link.style.pointerEvents = "auto";
      }
    }
  });

  window.addEventListener("whatsapp:position", ((e: CustomEvent) => {
    const state = window.__whatsappIcon;
    if (state) {
      state.isCustomPosition = true;
      if (state.link) {
        const { top, right, transform } = e.detail;
        if (top) state.link.style.top = top;
        if (right) state.link.style.right = right;
        if (transform) state.link.style.transform = transform;
        state.link.style.opacity = "1";
      }
    }
  }) as EventListener);

  window.addEventListener("whatsapp:reset", () => {
    const state = window.__whatsappIcon;
    if (state) {
      state.isCustomPosition = false;
      state.isHidden = false;
      state.updatePosition();
    }
  });

  function initWhatsappIcon() {
    const link = document.querySelector(
      ".whatsapp-link-selector"
    ) as HTMLElement;
    if (!link) return;

    const state = window.__whatsappIcon!;
    state.link = link;

    // Buscar el hero (primer section dentro de main)
    const hero = document.querySelector(
      "main > section:first-of-type"
    ) as HTMLElement;

    function updatePosition() {
      if (state.isCustomPosition) return;

      if (!hero) {
        link.style.top = "50%";
        link.style.transform = "translateY(-50%)";
        link.style.opacity = "1";
        return;
      }

      const heroRect = hero.getBoundingClientRect();
      const heroBottom = heroRect.bottom;
      const scrollThreshold = 200;

      if (window.scrollY > scrollThreshold) {
        link.style.top = "50%";
        link.style.transform = "translateY(-50%)";
      } else {
        link.style.top = `${heroBottom}px`;
        link.style.transform = "translateY(-50%)";
      }

      link.style.opacity = "1";
    }

    state.updatePosition = updatePosition;

    window.addEventListener("scroll", updatePosition);
    window.addEventListener("resize", updatePosition);

    // Aplicar estado según lo que se estableció antes de que el DOM cargara
    if (state.isHidden) {
      link.style.opacity = "0";
      link.style.pointerEvents = "none";
    } else if (!state.isCustomPosition) {
      updatePosition();
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initWhatsappIcon);
  } else {
    initWhatsappIcon();
  }
</script>
