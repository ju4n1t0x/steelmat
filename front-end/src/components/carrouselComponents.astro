---
import { Picture } from "astro:assets";

type CarouselItem = { src: ImageMetadata | string; alt?: string };

interface Props {
  items: CarouselItem[];
  containerClass?: string;
  outerClass?: string;
  interval?: number;
  showControls?: boolean;
  initialIndex?: number;
  width?: number | string;
  height?: number | string;
  aspectRatio?: string;
  imgClass?: string;
  carouselId?: string;
  quality?: "low" | "mid" | "high" | "max";
  widths?: number[];
  sizes?: string;
}

const {
  items = [],
  containerClass = "relative w-full h-96 overflow-hidden rounded-lg",
  outerClass = "relative overflow-hidden rounded-lg",
  interval = 0,
  showControls = true,
  initialIndex = 0,
  width,
  height,
  aspectRatio,
  imgClass = "object-cover",
  carouselId = "carousel",
  quality = "mid",
  widths = [640, 828, 1080, 1200, 1920],
  sizes = "(max-width: 768px) 100vw, 80vw",
} = Astro.props as Props;

const isAsset = (v: unknown) => typeof v !== "string";

const toCss = (v: string | number) =>
  typeof v === "number" ? `${v}px` : String(v);
const widthCss = width != null ? toCss(width as string | number) : undefined;
const heightCss = height != null ? toCss(height as string | number) : undefined;
const styleParts: string[] = [];
if (widthCss) styleParts.push(`width:${widthCss}`);
if (heightCss) styleParts.push(`height:${heightCss}`);
if (!heightCss && aspectRatio) styleParts.push(`aspect-ratio:${aspectRatio}`);
const containerStyle = styleParts.join(";");
---

<div class={outerClass}>
  <div
    class="relative"
    data-carousel={interval > 0 ? "slide" : "static"}
    data-carousel-interval={String(interval)}
    data-carousel-id={carouselId}
  >
    <div class={containerClass} style={containerStyle}>
      {
        items.map((it, i) => (
          <div
            class={`duration-700 ease-in-out ${i === initialIndex ? "" : "hidden"}`}
            data-carousel-item={i === initialIndex ? "active" : true}
          >
            {isAsset(it.src) ? (
              <Picture
                src={it.src as ImageMetadata}
                alt={it.alt ?? ""}
                formats={['avif', 'webp']}
                quality={quality}
                widths={widths}
                sizes={sizes}
                decoding="async"
                class={`absolute block w-full h-full ${imgClass} -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2`}
                loading={i === initialIndex ? "eager" : "lazy"}
              />
            ) : (
              <img
                src={it.src as string}
                alt={it.alt ?? ""}
                class={`absolute block w-full h-full ${imgClass} -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2`}
                loading="lazy"
              />
            )}
          </div>
        ))
      }
    </div>

    {
      showControls && (
        <>
          <button
            type="button"
            class="absolute top-0 start-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none"
            data-carousel-prev
          >
            <span class="inline-flex items-center justify-center w-6 h-6 sm:w-10 sm:h-10 rounded-full bg-black/40 group-hover:bg-black/60 group-focus:ring-4 group-focus:ring-gray-300">
              <svg
                class="w-2 h-2 sm:w-4 sm:h-4 text-white rtl:rotate-180"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 6 10"
                fill="none"
                aria-hidden="true"
              >
                <path
                  d="M5 1 1 5l4 4"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>
          </button>

          <button
            type="button"
            class="absolute top-0 end-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none"
            data-carousel-next
          >
            <span class="inline-flex items-center justify-center w-6 h-6 sm:w-10 sm:h-10 rounded-full bg-black/40 group-hover:bg-black/60 group-focus:ring-4 group-focus:ring-gray-300">
              <svg
                class="w-2 h-2 sm:w-4 sm:h-4 text-white rtl:rotate-180"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 6 10"
                fill="none"
                aria-hidden="true"
              >
                <path
                  d="m1 9 4-4-4-4"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </span>
          </button>
        </>
      )
    }
  </div>
</div>
